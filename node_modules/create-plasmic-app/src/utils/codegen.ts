import { banner } from "../lib";
import { spawnOrFail } from "../utils/cmd-utils";
import { installUpgrade } from "../utils/npm-utils";

export async function installCodegenDeps(opts: { projectPath: string }) {
  const { projectPath } = opts;
  const result = await installUpgrade("@plasmicapp/cli@0.1.330", { workingDir: projectPath });
  await spawnOrFail("npx patch-package", projectPath);
  return result;
}

export async function runCodegenSync(opts: {
  projectId: string;
  projectApiToken: string | undefined;
  projectHost: string | undefined;
  projectPath: string;
}) {
  const { projectId, projectApiToken, projectHost, projectPath } = opts;

  banner("SYNCING PLASMIC COMPONENTS");

  const project = projectApiToken
    ? `${projectId}:${projectApiToken}`
    : projectId;

  await spawnOrFail(`npx plasmic sync --yes -p ${project}${
    projectHost
      ? ` --host ${projectHost}`
      : ""
  }`, projectPath);
}
